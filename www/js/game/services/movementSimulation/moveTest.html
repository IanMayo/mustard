<!DOCTYPE html>
<html>
<head>
<title>Movement test</title>
<style>
    .retro
    {
        font-family:monospace ;
        background-color: #000;
        color:#0f0
    }
</style>
<script type="text/javascript">

function toRads(degVal) {
    return degVal / 180.0 * Math.PI;
}
function toDegs(radVal) {
    return radVal * 180.0 / Math.PI;
}

function calcNewHeight(curHeight, dHeight, climbRate, diveRate, secs) {
    var heightDelta = dHeight - curHeight;
    var newHeight;

    // see if it's a trivial height change
    if (Math.abs(heightDelta) < 0.01) {
        // trivial, just jump to it
        newHeight = dHeight;
    }
    else {
        // calculate how far we get
        var changeRate;
        if (heightDelta > 0) {
            changeRate = climbRate;
        }
        else {
            changeRate = -diveRate;
        }

        var heightChangeTime = heightDelta / changeRate;

        heightChangeTime = Math.min(heightChangeTime, secs);

        newHeight = curHeight + heightChangeTime * changeRate;
    }
    return newHeight;


}

function calcNewSpeed(curSpeed, demSpeed, accelerationRate, decelerationRate, timeDelta) {
    var speedDelta = demSpeed - curSpeed;
    var newSpeed;

    // see if it's a trivial speed change
    if (Math.abs(speedDelta) < 0.01) {
        // trivial, just jump to it
        newSpeed = demSpeed;
    }
    else {
        // calculate how far we get
        var changeRate;
        if (speedDelta > 0) {
            changeRate = accelerationRate;
        }
        else {
            changeRate = -decelerationRate;
        }

        var speedChangeTime = speedDelta / changeRate;

        speedChangeTime = Math.min(speedChangeTime, timeDelta);

        newSpeed = curSpeed + speedChangeTime * changeRate;
    }
    return newSpeed;
}


function calcNewCourse(curCourse, demCourse, turnRadius, speed, timeDelta) {
    // put the dem course in the +ve domain
    if (demCourse < 0) {
        demCourse += Math.PI * 2;
    }

    // and calculate the delta
    var courseDelta = demCourse - curCourse;

    // put the course delta into the +/- 180 domain
    if (courseDelta > Math.PI) {
        courseDelta -= 2 * Math.PI;
    }
    if (courseDelta < -Math.PI) {
        courseDelta += 2 * Math.PI;
    }

    var newCourse;

    // see if it's a trivial course change
    if (Math.abs(courseDelta) < 0.01) {
        // trivial, just jump to it
        newCourse = demCourse;
    }
    else {
        // calculate new course
        var turnRate = speed / turnRadius;

        // are we going left or right?
        if (courseDelta < 0)
            turnRate *= -1;

        var turnTime = courseDelta / turnRate;
        turnTime = Math.min(turnTime, timeDelta);

        newCourse = curCourse + turnTime * turnRate;

        if (newCourse < 0) {
            newCourse += Math.PI * 2;
        }

   //     console.log("cur course:" + toDegs(curCourse) + " turn time:" + turnTime + " new course:" + newCourse + " turn rate:" + turnRate + " time delta:" + timeDelta);

        // if we're very close to the dem course, just use the dem course
        if (Math.abs(newCourse - demCourse) < 0.0001) {
            newCourse = demCourse;
        }
    }
    return newCourse;
}

function doStraight(time, speed, course, movement) {
    movement.deltaLong += speed * time * Math.sin(course);
    movement.deltaLat += speed * time * Math.cos(course);
}

function doMove(newTime, curState, vPerf) {

    var oldTime = curState.time;
    var timeDelta = (newTime - oldTime) / 1000.0;
    var curSpeed = curState.speed;
    var curCourseRads = toRads(curState.course);
    var curHeight = curState.height;
    var demSpeed = curState.demSpeed;
    var demCourseRads = toRads(curState.demCourse);
    var demHeight = curState.demHeight;

    var movement = {deltaLat: 0.0, deltaLong: 0.0, deltaHeight: 0.0};

    var maxSpeed = vPerf.maxSpeed;
    var minSpeed = vPerf.minSpeed;

    // trim the demanded speed
    demSpeed = Math.min(demSpeed, maxSpeed);
    demSpeed = Math.max(demSpeed, minSpeed);

    // sort out the new height
    curHeight = calcNewHeight(curHeight, demHeight, vPerf.climbRate, vPerf.diveRate, timeDelta);

    // now for the acceleration
    var speedDelta = demSpeed - curSpeed;
    if (speedDelta < 0.01) {
        // ok, just jump to the new course
        curSpeed = demSpeed;
    }
    else {
        // ok, calculate how long we need to change speed
        curSpeed = calcNewSpeed(curSpeed, demSpeed, vPerf.accelerationRate, vPerf.decelerationRate, timeDelta);
    }

    // what was the mean speed during the time step?
    var meanSpeed = curSpeed - (speedDelta / 2);

    // remember the previous course
    var oldCourseRads = curCourseRads;

    // calcualate the new course
    curCourseRads = calcNewCourse(curCourseRads, demCourseRads, vPerf.turnRadius, meanSpeed, timeDelta);

    // work out the mean course
    var newCourseDelta = curCourseRads - oldCourseRads;
    if(newCourseDelta > Math.PI)
    {
        newCourseDelta -= Math.PI * 2;
    }
    var meanCourseRads = oldCourseRads + (newCourseDelta) / 2;

    // and now move
    doStraight(timeDelta, curSpeed, meanCourseRads, movement);

    // update the state object
    curState.lat += movement.deltaLat;
    curState.long += movement.deltaLong;

    curState.time = newTime;
    curState.height = curHeight;
    curState.course = toDegs(curCourseRads);
    curState.speed = curSpeed;
    curState.demCourse = toDegs(demCourseRads);
    curState.demSpeed = demSpeed;
    curState.demHeight = demHeight;
}

function run() {



    var tNow = 0;
    var tStep = 10000;

    outputMsg("model time,x,y,height,speed, course");

    for (var i = 0; i < 6; i++) {
        tNow += tStep;
        output(state);
        doMove(tNow, state, perf);
    }
    state.demCourse = 30;
    for (var j = 0; j < 19; j++) {
        tNow += tStep;
        output(state);
        doMove(tNow, state, perf);
    }
}

function runStraight() {
    var movement = {deltaLat: 0.0, deltaLong: 0.0, deltaHeight: 0.0};
    outputMsg("Origin " + movement.deltaLat + " " + movement.deltaLong + " " + movement.deltaHeight);
    doStraight(100, 10, Math.PI / 2, movement);
    outputMsg("One step East " + movement.deltaLat + " " + movement.deltaLong + " " + movement.deltaHeight);
    doStraight(100, 10, Math.PI, movement);
    outputMsg("One step South " + movement.deltaLat + " " + movement.deltaLong + " " + movement.deltaHeight);
    doStraight(100, 10, Math.PI + Math.PI / 2, movement);
    outputMsg("One step West " + movement.deltaLat + " " + movement.deltaLong + " " + movement.deltaHeight);
    doStraight(100, 10, 2 * Math.PI, movement);
    outputMsg("One step North " + movement.deltaLat + " " + movement.deltaLong + " " + movement.deltaHeight);
}

function output(state) {
    outputMsg((state.time / 1000) + ', ' + Math.floor(state.long) + ', ' + Math.floor(state.lat) + ', ' + Math.floor(state.height) + ', ' + state.speed + ', ' + Math.floor(state.course));
}

function outputMsg(msg) {
    var tNow = new Date();
    var box = document.getElementById("results");
    var outMsg = tNow.toLocaleTimeString() + ', ' + msg + '\n';
    if(box)
    {
        box.value = outMsg + box.value;
    }
    else
    {
        console.log("can't find the results object")
    }
}

function testHeightChange() {
    outputMsg("change 0 to 100: " + calcNewHeight(0, 100, 10, 20, 5));
    outputMsg("change 100 to 0: " + calcNewHeight(100, 0, 10, 20, 5));
    outputMsg("change 0.002 to 0: " + calcNewHeight(0.002, 0, 10, 20, 0.0001));
    outputMsg("try some zeros: " + calcNewHeight(0, 0, 0, 0, 0.00));
}
function testAccelTime() {
    outputMsg("accelerate 0 to 60, time lim, will get to: " + calcNewSpeed(0, 60, 1, 2, 10));
    outputMsg("decelerate 60 to 0, time lim, will get to: " + calcNewSpeed(60, 0, 1, 2, 10));
    outputMsg("accelerate 0 to 60, will get to: " + calcNewSpeed(0, 60, 1, 2, 100));
    outputMsg("decelerate 60 to 0, will get to: " + calcNewSpeed(60, 0, 1, 2, 100));
    outputMsg("maintain 60 to 60, will get to: " + calcNewSpeed(60, 60, 1, 2, 100));
}
function testNewCourse() {
    outputMsg("0 to 45: " + toDegs(calcNewCourse(toRads(0), toRads(45), 1000, 10, 5000)));
    outputMsg("45 to 0: " + toDegs(calcNewCourse(toRads(45), toRads(0), 1000, 10, 5000)));
    outputMsg("45 to -45: " + toDegs(calcNewCourse(toRads(45), toRads(-45), 1000, 10, 5000)));
    outputMsg("0 to 315: " + toDegs(calcNewCourse(toRads(0), toRads(315), 1000, 10, 5000)));
    outputMsg("0 to 45, time lim: " + toDegs(calcNewCourse(toRads(0), toRads(45), 1000, 2, 200)));
    outputMsg("45 to 0, time lim: " + toDegs(calcNewCourse(toRads(45), toRads(0), 1000, 2, 200)));
    outputMsg("45 to -45, time lim: " + toDegs(calcNewCourse(toRads(45), toRads(-45), 1000, 2, 200)));
    outputMsg("0 to 315, time lim: " + toDegs(calcNewCourse(toRads(0), toRads(315), 1000, 2, 200)));
}
function clearBox() {
    var box = document.getElementById("results");
    box.value = "";
}

var timerId;

var state =
{
    time: 0,
    lat: 0,
    long: 0,
    height: -40,
    course: 200,
    speed: 33,
    demCourse: 200,
    demSpeed: 33,
    demHeight: -10.0
};

var perf =
{
    turnRadius: 1200.0,
    accelerationRate: 0.07,
    decelerationRate: 0.5,
    minSpeed: 4,
    maxSpeed: 40,
    batteryUsage: 1.03,
    climbRate: 1,
    diveRate: 2
};
var tNow = 0;
const tStep = 2000;


function doStep()
{

    if(tNow == 0)
    {
        outputMsg("model time,x,y,height,speed, course");
    }

    // put the current boxes into the states
    var curCourseDegs = parseInt(document.getElementById("inCourse").value);
    var curSpeedKts = parseInt(document.getElementById("inSpeed").value);

    state.demCourse = curCourseDegs;
    state.demSpeed = curSpeedKts;

    // move the scenario forward
    tNow += tStep;
    doMove(tNow, state, perf);
    output(state);

    // put the results into the UI
    document.getElementById("outCourse").innerHTML="" + Math.floor(state.course);
    document.getElementById("outSpeed").innerHTML="" + Math.floor(state.speed);

    // and sort out the time
    var timeVal = new Date(tNow);
    document.getElementById("tNow").innerHTML=timeVal.toLocaleTimeString();

}

function doRun()
{
    var chkRun = document.getElementById("doRun");
    if(chkRun.checked)
    {
        // ok, run it
        console.log(" start running");
        timerId = window.setInterval("doStep()", 1000);
    }
    else
    {
        // ok, stop it
        console.log(" stop running");
        window.clearInterval(timerId);
    }
}
function changeCourse(val)
{
    var inCourse = document.getElementById("inCourse");
    inCourse.value = Math.floor(inCourse.value) + val;
}
function changeSpeed(val)
{
    var inSpeed = document.getElementById("inSpeed");
    inSpeed.value = Math.floor(inSpeed.value) + val;
}
</script>
</head>
<body>
<h1>Movement</h1>
<table>
    <tr>
        <td style="width:60%">
            <label for="results">Results:</label><br/><textarea rows="20" cols="80" id="results"></textarea>
        </td>
        <td><ul style="list-style-type: none">
       <!--   LEGACY TESTS
            <li>
                <input type="button" onclick="run()" value="run"/>
            </li>
            <li>
                <input type="button" onclick="runStraight()" value="straight"/>
            </li>
            <li>
                <input type="button" onclick="testHeightChange()" value="height change"/>
            </li>
            <li>
                <input type="button" onclick="testAccelTime()" value="accel time"/>
            </li>
            <li>
                <input type="button" onclick="testNewCourse()" value="new course"/>
            </li>  -->
            <li>
                <div id="tNow" style="width:90px" class="retro" >01:00:00</div>
            </li>
            <li>
                <input type="button" onclick="doStep()" value="single step"/>
            </li>
            <li>
                <label for="doRun" >Run</label><input type="checkbox" id="doRun" onchange="doRun()" value="Auto run"/>
            </li>
        </ul>
            <form id="inputs">
                <label for="inCourse">Course</label><input type="button" value="-5" onclick="changeCourse(-5)"><input  class="retro" size="3" type="text" value="90" id="inCourse"/><input type="button" value="+5" onclick="changeCourse(5)">
                <label for="inSpeed">Speed</label><input type="button" value="-1" onclick="changeSpeed(-1)"><input   class="retro" size="3" type="text" value="10" id="inSpeed"/><input type="button" value="+1" onclick="changeSpeed(1)">
            </form>
            <span>Course:</span><span class="retro"  id="outCourse">000</span>
            <span>Speed:</span><span class="retro"  id="outSpeed">000</span>
            <span>Location:</span><span class="retro"  id="outLocation">000,000</span>
        </td>
    </tr>
    <tr>
        <td>
        </td>
        <td>
        </td>
    </tr>
</table>

</body>
</html>