<!DOCTYPE html>
<html>
<head>
    <title>Movement test</title>
    <style>
        .retro {
            font-family: monospace;
            background-color: #000;
            color: #0f0
        }

        #Course, #Speed, #AngularVelocity, #SelfNoise, #SignalExcess {
            width: 300px;
            height: 200px;
            margin: 8px auto;
        }

        .leaflet-div-icon-red {
            background: #f00;
            border: 1px solid #666;
        }

        .leaflet-div-icon-green {
            background: #0f0;
            border: 1px solid #666;
        }

        .leaflet-div-icon-blue {
            background: #00f;
            border: 1px solid #666;
        }

        tr.diagnostics {
            background-color: #dddddd;
            color: #000;
        }

    </style>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css"/>
    <script type="text/javascript"
            src="dygraph-combined.js"></script>

</head>
<body class="retro">
<div>Physics Demonstrator UI</div>
<table style="width:100%">
    <tr>
        <td>
            <div id="Sonar"></div>
        </td>
        <td colspan="2">
            <div id="map" style="width: 600px; height: 300px"></div>
        </td>
    </tr>
    <tr>
        <td colspan="3">
            <fieldset style="float:left">
                <legend>Demanded</legend>
                <label for="inCourse">Course</label><input type="button" value="-5" onclick="changeCourse(-5)"><input
                    type="button" value="+5"
                    onclick="changeCourse(5)"><input
                    class="retro" size="6" type="text" value="90.00" id="inCourse"/>
                <label for="inSpeed">Speed</label><input type="button" value="-1" onclick="changeSpeed(-1)"><input
                    type="button" value="+1"
                    onclick="changeSpeed(1)"><input
                    class="retro" size="6" type="text" value="10.00" id="inSpeed"/>
            </fieldset>
            <fieldset style="float:left">
                <legend>Actual</legend>
                <span class="retro" id="outCourse">000.00</span>&deg
                <span class="retro" id="outSpeed">00.00</span>m/s
                <span class="retro" id="outLocation">00.00.00.N, 000.00.00.W</span>
            </fieldset>
            <fieldset>
                <legend>Time</legend>
                <input style="float:left;font-style: italic" type="button" onclick="doStep()" value="[Step]"/>

                <div style="float:left" id="tNow" class="retro">01:00:00</div>
                <input type="button" id="btnPause" onclick="doPause()" value="||"/>
                <input type="button" id="btnPlay" onclick="doPlay()" value=">"/>
                <input type="button" id="btnSlower" onclick="doSlower()" value="-"/>/
                <input type="button" id="btnFaster" onclick="doFaster()" value="+"/>
                <span id="accelRate" style="width:90px">[stopped]</span>
            </fieldset>
        </td>
    </tr>
</table>
<table style="width:100%">
    <tr class="diagnostics">
        <td>
            <div id="SelfNoise"></div>
        </td>
        <td>
            <div id="SignalExcess"></div>
        </td>
        <td>
            <fieldset>
                <legend>Diagnostics</legend>
                <ul>
                    <li><input type="checkbox" id="showTarget"><label for="showTarget">Show Target</label></li>
                    <li><input checked type="checkbox" id="showSelfNoise"><label for="showSelfNoise">Show Self
                        Noise</label></li>
                    <li><input checked type="checkbox" id="showCourse"><label for="showCourse">Show Course</label></li>
                    <li><input checked type="checkbox" id="showSpeed"><label for="showSpeed">Show Speed</label></li>
                    <li><input checked type="checkbox" id="showAngularVelocity"><label for="showAngularVelocity">Show
                        Angular Velocity</label></li>
                </ul>
            </fieldset>
        </td>
    </tr>
    <tr class="diagnostics">
        <td>
            <div id="Course"></div>
        </td>
        <td>
            <div id="Speed"></div>
        </td>
        <td>
            <div id="AngularVelocity"></div>
        </td>
    </tr>
</table>
<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
<script src="geo.js"></script>
<script src="movement.js"></script>
<script src="detection.js"></script>

<script type="text/javascript">

var scenario = {
    "vessels": [
        {
            "name": "Ownship",
            "categories": ["BLUE", "SURFACE", "WARSHIP"],
            "behaviours": [],
            "sonars": [
                {
                    "name": "BASIC_TOWED",
                    "categories": ["HAS_BOW_NULL"],
                    "offset": -1000,
                    "ArrayGain": 20,
                    "DT":-8
                }
            ],
            "radiatedNoise": {
                "baseLevel": 90,
                "speedPattern": "Uniform"    /* pattern of how the noise level changes with speed */
            },
            "state": {
                time: 0,
                location: {lat: 53, long: -3},
                height: 0,
                course: 100,
                speed: 10,
                demCourse: 100,
                demSpeed: 10,
                demHeight: -10.0
            },
            "perf": {
                turnRadius: 1200.0,
                accelerationRate: 0.3,
                decelerationRate: 0.8,
                minSpeed: 4,
                maxSpeed: 40,
                climbRate: 1,
                diveRate: 2
            }
        },
        {
            "name": "Target",
            "categories": ["RED", "SUBSURFACE", "SUBMARINE"],
            "behaviours": [],
            "sonars": [
                {
                    "name": "BASIC_HULL",
                    "categories": ["NO_SIMPLE_SELF_NOISE", "NO_COMPLEX_SELF_NOISE", "NO_AMBIGUOUS"],
                    "offset": 0,
                    "ArrayGain": 28,
                    "DT":-8
                }
            ],
            "radiatedNoise": {
                "baseLevel": 100,
                "speedPattern": "Uniform"    /* pattern of how the noise level changes with speed */
            },
            "state": {
                time: 0,
                location: {lat: 53.00005, long: -3.00004},
                height: -40,
                course: 200,
                speed: 8,
                demCourse: 200,
                demSpeed: 8,
                demHeight: -40.0,
                batteryLevel: 90
            },
            "perf": {
                turnRadius: 1200.0,
                accelerationRate: 0.3,
                decelerationRate: 0.8,
                minSpeed: 4,
                maxSpeed: 20,
                batteryUsage: 0.00035, /* should be: 0.00035  */
                chargeRate: 0.013,     /* should be: 0.013  */
                climbRate: 1,
                diveRate: 2
            }
        }


    ],
    "environment": {},
    "objectives": {}
};

/* timer-related objects

 */
var timerId;            // the id of a running timer
var tNow = 0;           // the current time
const tStep = 2000;     // the model time step
var accelRate = 1;      // how fast to run model time


function doStep() {

    var v1 = scenario.vessels[0];
    var v2 = scenario.vessels[1];

    // is this the first step?
    if (tNow == 0) {
        // do some init
        document.getElementById("inCourse").value = v1.state.demCourse.toFixed(2);
        document.getElementById("inSpeed").value = v1.state.demSpeed.toFixed(2);
    }

    // put the current boxes into the states
    var curCourseDegs = parseInt(document.getElementById("inCourse").value);
    var curSpeedKts = parseInt(document.getElementById("inSpeed").value);

    v1.state.demCourse = curCourseDegs;
    v1.state.demSpeed = curSpeedKts;

    /////////////////////////
    // GAME LOOP STARTS HERE
    /////////////////////////


    // move the scenario forward
    tNow += tStep;

    // loop through the vessels
    for (var i = 0; i < scenario.vessels.length; i++) {
        var thisV = scenario.vessels[i];
        doMove(tNow, thisV.state, thisV.perf);
    }

    // now that everyone is in their new location, do the detections
    for (var j = 0; j < scenario.vessels.length; j++) {
        var thisV2 = scenario.vessels[j];
        doDetections(tNow, thisV2, scenario.vessels);
    }

    // and now the decisions

    /////////////////////////
    // GAME LOOP ENDS HERE
    /////////////////////////

    // put the results into the UI
    document.getElementById("outCourse").innerHTML = "" + v1.state.course.toFixed(2);
    document.getElementById("outSpeed").innerHTML = "" + v1.state.speed.toFixed(2);

    var locStr = "" + toString(v1.state.location.lat, v1.state.location.long, 'DMS');
    document.getElementById("outLocation").innerHTML = "" + locStr;

    // and sort out the time
    var timeVal = new Date(tNow);
    document.getElementById("tNow").innerHTML = timeVal.toLocaleTimeString();

    // try to move the marker
    var ownshipPos = L.latLng(v1.state.location.lat, v1.state.location.long);

    // and the sonar marker
    var sonarLoc = v1.sonars[0].location;
    var sonarPos = L.latLng(sonarLoc.lat, sonarLoc.long);
    updateOwnship(ownshipPos, sonarPos, v1.state.course, v1.state.speed);

    // do we need to move the map?
    if (!map.getBounds().contains(ownshipPos)) {
        map.panTo(ownshipPos);
    }

    // try to move other marker
    var otherPos = L.latLng(v2.state.location.lat, v2.state.location.long);
    updateMarker(v2.name, otherPos);

    // try to show a graph marker
    addPoint("Course", tNow, v1.state.demCourse, v1.state.course);
    addPoint("Speed", tNow, v1.state.demSpeed, v1.state.speed);
    addPoint("AngularVelocity", tNow, -50 + Math.random() * 100);
    addPoint("SelfNoise", tNow, v1.state.osNoise, v2.state.osNoise);

    addPoint("SignalExcess", tNow, v1.state.SE, v2.state.SE);

    // share the good news about detections
    if (v1.newDetections) {
        var dets;
        for (var k = 0; k < v1.newDetections.length; k++) {
            var thisD = v1.newDetections[k];

            // is this the first item?
            if (!dets) {
                dets = [new Date(thisD.time)];
            }

            // add this detection to the list
            dets.push(thisD.bearing);

        }
        addDetections(dets);
    }

}

function doPause() {
    if (timerId != null) {
        window.clearInterval(timerId);
        document.getElementById("accelRate").innerHTML = "[stopped]";
    }
}

function updateInterval() {
    doPause();
    timerId = window.setInterval("doStep()", 1000 / accelRate);
    document.getElementById("accelRate").innerHTML = "[x" + accelRate + "]";
}

function doPlay() {
    accelRate = 1;
    updateInterval();
}

function doFaster() {
    accelRate *= 2;
    updateInterval()
}

function doSlower() {
    accelRate /= 2;
    updateInterval()
}

function changeCourse(val) {
    var inCourse = document.getElementById("inCourse");
    var newCourse = parseFloat(inCourse.value) + val;
    if (newCourse >= 360) {
        newCourse -= 360;
    }
    else if (newCourse < 0) {
        newCourse += 360;
    }
    inCourse.value = newCourse.toFixed(2);
}
function changeSpeed(val) {
    var inSpeed = document.getElementById("inSpeed");
    inSpeed.value = (parseFloat(inSpeed.value) + val).toFixed(2);
}

/** store a collection of position markers
 */
var posDict = {};

var osHeadLine, sonarLine;

function updateOwnship(oPos, sonarPos, course, speed) {
    // first position the marker
    updateMarker("Ownship", oPos);

    // get oPos in screen coords
    var sPos = map.project(oPos);
    var FACTOR = 2;
    var dx = Math.sin(toRads(course)) * speed * FACTOR;
    var dy = -Math.cos(toRads(course)) * speed * FACTOR;
    var offset = L.point(dx, dy);
    var otherPos = sPos.add(offset);
    var otherEnd = map.unproject(otherPos);
    var locations = [oPos, otherEnd];

    // now the heading indicator
    if (!osHeadLine) {
        osHeadLine = L.polyline(locations, {color: 'blue', weight: 2}).addTo(map);
    }
    else {
        osHeadLine.setLatLngs(locations);
    }

    var sonarlocations = [oPos, sonarPos];
    if (!sonarLine) {
        sonarLine = L.polyline(sonarlocations, {color: '#111', weight: 2}).addTo(map);
    }
    else {
        sonarLine.setLatLngs(sonarlocations);
    }

    // now the sonar
    //  updateMarker("Sonar", sonarPos);
}

/** for the track of the given name, specify a new marker location
 *
 * @param vName
 * @param location
 */
function updateMarker(vName, location) {
    // do we have it already?
    var thisPos = posDict[vName];

    // check we can show the target
    if (vName == "Target" && !showThis("showTarget")) {
        thisPos = null;
    }
    else if (thisPos == null) {
        var myIcon;

        // ok - new marker.
        if (vName == "Ownship") {
            myIcon = L.divIcon({className: 'leaflet-div-icon-blue'});
            thisPos = L.marker(location, {title: vName, icon: myIcon}).addTo(map);
        }
        else if (vName == "Target") {
            myIcon = L.divIcon({className: 'leaflet-div-icon-red'});
            thisPos = L.marker(location, {title: vName, icon: myIcon}).addTo(map);
        }
        else if (vName == "Sonar") {
            myIcon = L.divIcon({className: 'leaflet-div-icon-green'});
            thisPos = L.marker(location, {title: vName, icon: myIcon}).addTo(map);
        }
        else {
            console.log("marker not found for:" + vName);
        }
        posDict[vName] = thisPos;
    }


    if (thisPos) {
        thisPos.setLatLng(location);
    }
}

function showThis(checkboxName) {
    var theControl = document.getElementById(checkboxName);
    return !theControl || theControl.checked;
}

var map = L.map('map', {minZoom: 0, maxZoom: 30}).setView([50, -4], 12);

L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attributionControl: false
}).addTo(map);

L.control.scale({metric: true, imperial: true}).addTo(map);


function addDetections(dataValues) {
    var data = dataSeries["Sonar"];
    var graph = graphs["Sonar"];
    data.push(dataValues);
    // calculate the 5 minute window
    var time = dataValues[0];
    var newStart = new Date(time - 10000 * 60);

    // get the chart to redraw
    graph.updateOptions({
        'colors': ["#0f0", "#0f0", "#0f0", "#0f0", "#0f0", "#0f0", "#0f0", "#0f0", "#0f0", "#0f0"],
        'strokePattern': [0, 4], showLabelsOnHighlight: false,
        axes: {
            x: {axisLabelColor: "#0f0"},
            y: {axisLabelColor: "#0f0"}
        },
       'pointSize': 4, 'file': data,
        dateWindow: [newStart, new Date(time)] });
}

function addPoint(series, time, demValue, actualValue) {
    // get the sources
    var data = dataSeries[series];
    var graph = graphs[series];

    // store the new data values
    data.push([new Date(time), demValue, actualValue]);

    // calculate the 5 minute window
    var newStart = new Date(time - 2000 * 60);

    if (showThis("show" + series)) {
        // get the chart to redraw
        graph.updateOptions({ 'file': data, dateWindow: [newStart, new Date(time)] });
    }
}

function initGraph(name, datum, labels, yLabel, valueRange) {
    //
    var data = [datum];

    var thisGraph = new Dygraph(document.getElementById(name), data,
            {
                drawPoints: true,
                showRoller: false,
                valueRange: valueRange,
                legend: 'always',
                labels: labels,
                ylabel: yLabel,
                yLabelWidth: 12,
                axes: {
                    x: {axisLabelFontSize: 10},
                    y: {axisLabelFontSize: 10}
                }
            }
    );

    // and store them
    dataSeries[name] = data;
    graphs[name] = thisGraph;
}


// collections of graphs & data series'
var dataSeries = {};
var graphs = {};

// initialise the graphs
initGraph("SignalExcess", [new Date(0), 0, 0], ['Time', 'Own SE', 'tgt SE'], "dB", [-50,50]);
initGraph("Course", [new Date(0), 0, 0], ['Time', 'Demanded Course', 'Actual Course'], "Course (degs)", [0.0, 360]);
initGraph("Speed", [new Date(0), 0, 0], ['Time', 'Demanded Speed', 'Actual Speed'], "Speed (m/s)", [0.0, 40]);
initGraph("AngularVelocity", [new Date(0), 0], ['Time', 'Angular Velocity'], "Degs/sec", [0, 100]);
initGraph("SelfNoise", [new Date(0), 0, 0], ['Time', 'Own noise', 'Target noise'], "dB", [0, 200]);
initGraph("Sonar", [new Date(0), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], ['Time', 'S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8', 'S9', 'S10'], "Bearing", [0, 360]);

</script>
</body>
</html>