<!DOCTYPE html>
<html>
<head>
    <title>Movement test</title>
    <style>
        .retro {
            font-family: monospace;
            background-color: #000;
            color: #0f0
        }

        #Course, #Speed , #AngularVelocity, #SelfNoise  {
            width : 300px;
            height: 200px;
            margin: 8px auto;
        }

    </style>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css"/>
    <script type="text/javascript"
            src="dygraph-combined.js"></script>

</head>
<body>
<div>Physics Demonstrator UI</div>
<table style="width:100%">
    <tr>
        <td>
            Sonar goes here
        </td>
        <td colspan="2">
            <span>MAP:</span>

            <div id="map" style="width: 600px; height: 300px"></div>
        </td>
    </tr>
    <tr>
        <td colspan="3">
            <fieldset style="float:left">
                <legend>Demanded</legend>
                <label for="inCourse">Course</label><input type="button" value="-5" onclick="changeCourse(-5)"><input
                    class="retro" size="6" type="text" value="90.00" id="inCourse"/><input type="button" value="+5"
                                                                                           onclick="changeCourse(5)">
                <label for="inSpeed">Speed</label><input type="button" value="-1" onclick="changeSpeed(-1)"><input
                    class="retro" size="6" type="text" value="10.00" id="inSpeed"/><input type="button" value="+1"
                                                                                          onclick="changeSpeed(1)">
            </fieldset>
            <fieldset style="float:left">
                <legend>Actual</legend>
                <span>Course:</span><span class="retro" id="outCourse">000.00</span>
                <span>Speed:</span><span class="retro" id="outSpeed">00.00</span>
                <span>Location:</span><span class="retro" id="outLocation">0.0000000,0.0000000</span>
            </fieldset>
            <fieldset>
                <legend>Time</legend>
                <input style="float:left;font-style: italic" type="button" onclick="doStep()" value="[Step]"/>

                <div style="float:left" id="tNow" class="retro">01:00:00</div>
                <input type="button" id="btnPause" onclick="doPause()" value="||"/>
                <input type="button" id="btnPlay" onclick="doPlay()" value=">"/>
                <input type="button" id="btnFaster" onclick="doFaster()" value=">>"/>
                <span id="accelRate" style="width:90px">[stopped]</span>
            </fieldset>
        </td>
    </tr>
    <tr>
        <td>
            <div id="SelfNoise"></div>
        </td>
        <td>
            <div id="pendingA"></div>
        </td>
        <td>
            <div id="pendingB"></div>
        </td>
    </tr>
    <tr>
        <td>
            <div id="Course"></div>
        </td>
        <td>
            <div id="Speed"></div>
        </td>
        <td>
            <div id="AngularVelocity"></div>
        </td>
    </tr>
</table>
<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
<script src="geo.js"></script>
<script src="movement.js"></script>
<script src="detection.js"></script>

<script type="text/javascript">

    var scenario = {
        "vessels" : [
            {
                "name": "Ownship",
                "categories":  ["BLUE", "SURFACE", "WARSHIP"],
                "behaviours": [],
                "sonars" : [
                    {
                        "name":"BASIC_TOWED",
                        "categories" : [],
                        "RD" : 1.4,
                        "offset" : -1000
                    }],
                "radiatedNoise" : {
                    "baseLevel" : 100,
                    "speedPattern" : "Uniform"    /* pattern of how the noise level changes with speed */
                },
                "state": {
                    time: 0,
                    location: {lat: 53, long: -3},
                    height: -40,
                    course: 100,
                    speed: 10,
                    demCourse: 100,
                    demSpeed: 10,
                    demHeight: -10.0
                },
                "perf": {
                    turnRadius: 1200.0,
                    accelerationRate: 0.3,
                    decelerationRate: 0.8,
                    minSpeed: 4,
                    maxSpeed: 40,
                    batteryUsage: 1.03,
                    climbRate: 1,
                    diveRate: 2
                }
            },
            {
                "name": "Target",
                "categories":  ["RED", "SUBSURFACE", "SUBMARINE"],
                "behaviours": [],
                "sonars" : [
                    {
                        "name":"BASIC_HULL",
                        "categories" : ["NO_SIMPLE_SELF_NOISE", "NO_COMPLEX_SELF_NOISE","NO_AMBIGUOUS"],
                        "RD" : 1.4,
                        "offset" : 0
                    }],
                "radiatedNoise" : {
                    "baseLevel" : 110,
                    "speedPattern" : "Uniform"    /* pattern of how the noise level changes with speed */
                },
                "state": {
                    time: 0,
                    location: {lat: 53.00005, long: -3.00004},
                    height: -40,
                    course: 200,
                    speed: 8,
                    demCourse: 200,
                    demSpeed: 8,
                    demHeight: -10.0
                },
                "perf": {
                    turnRadius: 1200.0,
                    accelerationRate: 0.3,
                    decelerationRate: 0.8,
                    minSpeed: 4,
                    maxSpeed: 20,
                    batteryUsage: 1.03,
                    climbRate: 1,
                    diveRate: 2
                }
            }


        ],
        "environment" : {},
        "objectives" : {}
    };

    /* timer-related objects

     */
    var timerId;            // the id of a running timer
    var tNow = 0;           // the current time
    const tStep = 2000;     // the model time step
    var accelRate = 1;      // how fast to run model time


    function doStep() {

        var v1 = scenario.vessels[0];
        var v2 = scenario.vessels[1];

        // is this the first step?
        if (tNow == 0) {
            // do some init
            document.getElementById("inCourse").value = v1.state.demCourse.toFixed(2);
            document.getElementById("inSpeed").value = v1.state.demSpeed.toFixed(2);
        }

        // put the current boxes into the states
        var curCourseDegs = parseInt(document.getElementById("inCourse").value);
        var curSpeedKts = parseInt(document.getElementById("inSpeed").value);

        v1.state.demCourse = curCourseDegs;
        v1.state.demSpeed = curSpeedKts;

        /////////////////////////
        // GAME LOOP STARTS HERE
        /////////////////////////


        // move the scenario forward
        tNow += tStep;

        // loop through the vessels
        for(var i=0;i<scenario.vessels.length;i++)
        {
            var thisV = scenario.vessels[i];
            doMove(tNow, thisV.state, thisV.perf);
        }

        // now that everyone is in their new location, do the detections
        for(var j=0;j<scenario.vessels.length;j++)
        {
            var thisV2 = scenario.vessels[j];
            doDetections(tNow, thisV2, scenario.vessels);
        }

        // and now the decisions

        /////////////////////////
        // GAME LOOP ENDS HERE
        /////////////////////////

        // put the results into the UI
        document.getElementById("outCourse").innerHTML = "" + v1.state.course.toFixed(2);
        document.getElementById("outSpeed").innerHTML = "" + v1.state.speed.toFixed(2);

        var locStr = "" + toString(v1.state.location.lat, v1.state.location.long, 'DMS');
        document.getElementById("outLocation").innerHTML = "" + locStr;

        // and sort out the time
        var timeVal = new Date(tNow);
        document.getElementById("tNow").innerHTML = timeVal.toLocaleTimeString();

        // try to move the marker
        var newPos = L.latLng(v1.state.location.lat, v1.state.location.long);
        updateMarker(v1.name, newPos);

        // do we need to move the map?
        if (!map.getBounds().contains(newPos)) {
            map.panTo(newPos);
        }

        // and the sonar marker
        var sonarLoc = v1.sonars[0].location;
        var sonarPos = L.latLng(sonarLoc.lat, sonarLoc.long);
        updateMarker(v1.sonars[0].name, sonarPos);

        // try to move other marker
        var otherPos = L.latLng(v2.state.location.lat, v2.state.location.long);
        updateMarker(v2.name, otherPos);

        // try to show a graph marker
        addPoint("Course", tNow,  v1.state.demCourse, v1.state.course);
        addPoint("Speed", tNow,  v1.state.demSpeed, v1.state.speed);
        addPoint("AngularVelocity", tNow, -50 + Math.random()*100);
        addPoint("SelfNoise", tNow,  v1.radiatedNoise.osNoise, v2.radiatedNoise.osNoise);

    }

    function doPause() {
        if (timerId != null) {
            window.clearInterval(timerId);
            document.getElementById("accelRate").innerHTML = "[stopped]";
        }
    }

    function updateInterval() {
        doPause();
        timerId = window.setInterval("doStep()", 1000 / accelRate);
        document.getElementById("accelRate").innerHTML = "[x" + accelRate + "]";
    }

    function doPlay() {
        accelRate = 1;
        updateInterval();
    }

    function doFaster() {
        accelRate *= 2;
        updateInterval()
    }

    function changeCourse(val) {
        var inCourse = document.getElementById("inCourse");
        var newCourse = parseFloat(inCourse.value) + val;
        if (newCourse >= 360) {
            newCourse -= 360;
        }
        else if (newCourse < 0) {
            newCourse += 360;
        }
        inCourse.value = newCourse.toFixed(2);
    }
    function changeSpeed(val) {
        var inSpeed = document.getElementById("inSpeed");
        inSpeed.value = (parseFloat(inSpeed.value) + val).toFixed(2);
    }

    /** store a collection of position markers
     */
    var posDict = {};

    /** for the track of the given name, specify a new marker location
     *
     * @param vName
     * @param location
     */
    function updateMarker(vName, location) {
        // do we have it already?
        var thisPos = posDict[vName];
        if (thisPos == null) {
            // ok - new marker.
            if(vName == "Ownship")
            {
                thisPos = L.marker(location,{title:vName}).addTo(map);
            }
            else if(vName == "Target")
            {
                // use a new marker
                var newIcon = L.icon({iconUrl:'YellowSub.png'});
                thisPos = L.marker(location, {title:vName, icon:newIcon}).addTo(map);
            }
            else if(vName == "BASIC_TOWED")
            {
                // use a new marker
                var newIcon = L.icon({iconUrl:'sonar.png'});
                thisPos = L.marker(location, {title:vName, icon:newIcon}).addTo(map);
            }
            else
            {
                console.log("marker not found for:" + vName);
            }
            posDict[vName] = thisPos;
        }

        thisPos.setLatLng(location);
    }

    var map = L.map('map', {minZoom: 0, maxZoom: 30}).setView([50, -4], 13);

    L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>'
    }).addTo(map);


    function addPoint(series, time, demValue, actualValue)
    {
        // get the sources
        var data = dataSeries[series];
        var graph = graphs[series];

        // store the new data values
        data.push([new Date(time), demValue, actualValue]);

        // calculate the 5 minute window
        var newStart = new Date(time - 2000 * 60);

        // get the chart to redraw
        graph.updateOptions( { 'file': data, dateWindow:[newStart, new Date(time)] } );
    }

    function initGraph(name, datum,labels, yLabel, valueRange)
    {
        //
        var data = [datum];

        var thisGraph = new Dygraph(document.getElementById(name), data,
                {
                    drawPoints: true,
                    showRoller: false,
                    valueRange: valueRange,
                    labels: labels,
                    legend:"always",
                    ylabel:yLabel
                });

        // and store them
        dataSeries[name] = data;
        graphs[name] = thisGraph;
    }

    // collections of graphs & data series'
    var dataSeries ={};
    var graphs = {};

    // initialise the graphs
    initGraph("Course", [new Date(0),0,0],['Time', 'Demanded Course', 'Actual Course'], "Course (degs)",[0.0, 360] );
    initGraph("Speed", [new Date(0),0,0],['Time', 'Demanded Speed', 'Actual Speed'], "Speed (m/s)",[0.0, 40] );
    initGraph("AngularVelocity", [new Date(0),0],['Time', 'Angular Velocity'], "Turn Rate (degs/s)",[-50, 50] );
    initGraph("SelfNoise", [new Date(0),0,0],['Time', 'Own noise', 'Target noise'], "dB",[0, 200] );

</script>
</body>
</html>