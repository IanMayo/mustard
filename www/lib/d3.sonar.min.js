/**
 * d3 Sonar
 * ========
 * The MIT License (MIT)
 *
 * Copyright (c) 2014 Ashish Singh [ashish.me@outlook.com]
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
(function(){d3.sonar=function(){var M,W=0,Z,m=[0,360],g=[0,45,90,135,180,225,270,315,360],I=function(ab){return ab},w=function(ab){return ab},x=d3.scale.linear().domain(m),C,k=true,A="Time",S=true,q="Degree ยบ",H,U=d3.time.scale(),l,r,aa=5,z,b=d3.time.format("%H:%M:%S"),N,n=function(){},h=function(){},D=function(){},K=function(){},R,s,a,d,y=$(window).height()*0.8,F=$(window).width()*0.8,V=0,o={top:40,left:100,bottom:40,right:50},Q,Y,P=true,L,f=d3.map([]),T=d3.map([]),t=0,e=0,j=true,X=false,p=30*1000,v=0,c=[],O={indicator:"#BCDF1B",heading:"#1A68DB"},i=true,G=!i,B,u="clip-"+Math.round(new Date().getTime()*Math.random()),J=0;function E(){E.init();E.render()}E.init=function(){Z=d3.select(M).append("svg").attr("class","chart").append("g").classed("g-wrapper",true).attr("transform","translate("+o.left+","+o.top+")");Z.append("rect").classed("bg",true);firstLoad=true;a=M.getBoundingClientRect().width;d=M.getBoundingClientRect().height;a=a-o.left-o.right;d=d-o.top-o.bottom;Q={width:a,height:d};x.domain(m).range([0,a]);if(l){U.domain(l)}U.range([d,0]);C=d3.svg.axis().scale(x).tickValues(g).tickFormat(I).orient("top");r=d3.svg.axis().scale(U).ticks(aa).tickFormat(function(ab){return b(ab)}).orient("left");n=d3.scale.linear().domain([1,10]).range([2,5]);t=a;e=d;B=Z.append("clipPath").attr("id",u).append("rect").attr("width",a).attr("height",d);H=Z.append("g").attr("class","x axis").attr("transform","translate(0,0)");H.append("text").classed("axis-unit",true).attr("transform","translate("+a+",0)").attr("y",0).attr("dy","1.71em").style("text-anchor","end").text(q);z=Z.append("g").attr("class","y axis").style("opacity",l===undefined?0:1);z.append("text").classed("axis-unit",true).attr("transform","translate(0,"+d+")rotate(-90)").attr("y",6).attr("dy",".71em").attr("dx","2.71em").style("text-anchor","end").text(A);N=Z.append("g").classed("gMain",true);h=d3.svg.line().interpolate("basis").y(function(ab){return U(ab[R.y])}).x(function(ab){return x(w(ab[R.x]))});D=d3.svg.line().interpolate("basis").y(function(ab){return U(ab[s.y])}).x(function(ab){return x(w(ab[s.x]))});if(P){setInterval(E.reInit,1000)}return E};E.reInit=function(){a=M.getBoundingClientRect().width;d=M.getBoundingClientRect().height;a=a-o.left-o.right;d=d-o.top-o.bottom;Q={width:a,height:d};x.range([0,a]);var ah=d3.min(c),af;if(ah){l=true;af=new Date(ah.getTime()-p);U.domain([af,ah]);af=null}U.range([d,0]);aa=Math.ceil(d/60);r.ticks(aa);var ac=Math.floor((U.domain()[1].getTime()-U.domain()[0].getTime())/aa),ae=[],ag=U.domain()[0].getTime();for(var ad=0;ad<aa;ad++){var ab=new Date(ag+ac*ad);ae.push(ab);ab=null}r.tickValues(ae);if((t!=a)||(e!=d)){t=a;e=d;Z.select("rect.bg").attr("width",a).attr("height",d);Z.attr("width",a).attr("height",d);B.attr("width",a).attr("height",d);H.select(".axis-unit").attr("transform","translate("+a+",0)");z.select(".axis-unit").attr("transform","translate(0,"+d+")rotate(-90)")}z.style("opacity",S?1:0).call(r);H.style("opacity",k?1:0).call(C)};E.render=function(){var ac=W;a=Q.width;d=Q.height;var ad=N.selectAll(".headings").data(T.entries());if(i){if(l&&!J){J=(U(U.domain()[0])-U(U.domain()[1]))/(U.domain()[1].getTime()-U.domain()[0].getTime())}ad.enter().append("g").attr("clip-path","url(#"+u+")").classed("headings",true).on("click",function(ae){K(ae)});ad.each(function(ae,ag){var af=d3.select(this).selectAll(".heading").data(ae.value);af.enter().append("ellipse").classed("heading",true).attr("cx",function(ah){return x(w(ah[R.x]))}).attr("cy",function(ah){return U(ah[R.y])}).attr("rx",function(ah){return n(ah.strength)}).attr("ry",function(ai,ah){return v*J}).style("fill",function(ah){return O.heading});af.attr("cx",function(ah){return x(w(ah[R.x]))}).attr("cy",function(ah){return U(ah[R.y])}).style("opacity",1);af.exit().remove()})}if(G){ad.enter().append("path").attr("clip-path","url(#"+u+")").attr("class","headings line").on("click",function(ae){K(ae)});ad.attr("d",function(ae){return h(ae.value)}).style("stroke",function(ae){return O.heading})}ad.moveToFront();ad.exit().remove();var ab=N.selectAll(".indicators").data(f.entries());if(i){ab.enter().append("g").attr("clip-path","url(#"+u+")").classed("indicators",true).on("click",function(ae){K(ae)});ab.each(function(ae,ag){var af=d3.select(this).selectAll(".indicator").data(ae.value);af.enter().append("ellipse").classed("indicator",true).attr("cx",function(ah){return x(w(ah[s.x]))}).attr("cy",function(ah){return U(ah[s.y])}).attr("rx",function(ah){return n(ah.strength)}).attr("ry",function(ah){return v*J}).style("fill",function(ah){return O.indicator});af.attr("cx",function(ah){return x(w(ah[s.x]))}).attr("cy",function(ah){return U(ah[s.y])}).style("opacity",1);af.exit().remove()})}if(G){ab.enter().append("path").attr("clip-path","url(#"+u+")").attr("class","indicators line").on("click",function(ae){K(ae)});ab.attr("d",function(ae){return D(ae.value)}).style("stroke",function(ae){return O.indicator})}ab.exit().remove();if(firstLoad){firstLoad=false}return E};E.update=function(){E.reInit();E.render()};E.container_el=function(ab){if(!arguments.length){return M}M=ab;return E};E.data=function(ab){if(!arguments.length){return Y}Y=ab;return E};E.margin=function(ab){if(!arguments.length){return o}o=ab;return E};E.isResponsive=function(ab){if(!arguments.length){return P}P=ab;return E};E.headingPath=function(ab){if(!arguments.length){return h}h=ab;return E};E.detectionPath=function(ab){if(!arguments.length){return D}D=ab;return E};E.xScale=function(ab){if(!arguments.length){return x}x=ab;return E};E.xDomain=function(ab){if(!arguments.length){return m}m=ab;return E};E.xTickValues=function(ab){if(!arguments.length){return g}g=ab;return E};E.xTickFormat=function(ab){if(!arguments.length){return I}I=ab;return E};E.xTickFormatInverse=function(ab){if(!arguments.length){return w}w=ab;return E};E.xAxisLabel=function(ab){if(!arguments.length){return q}q=ab;return E};E.showXAxis=function(ab){if(!arguments.length){return k}k=ab;return E};E.showYAxis=function(ab){if(!arguments.length){return k}k=ab;return E};E.yAxisLabel=function(ab){if(!arguments.length){return A}A=ab;return E};E.yScale=function(ab){if(!arguments.length){return U}U=ab;return E};E.yDomain=function(ab){if(!arguments.length){return l}l=ab;return E};E.yTicks=function(ab){if(!arguments.length){return aa}aa=ab;return E};E.headingKeys=function(ab){if(!arguments.length){return R}R=ab;return E};E.detectionKeys=function(ab){if(!arguments.length){return s}s=ab;return E};E.purgeOldData=function(ab){if(!arguments.length){return j}j=ab;return E};E.dataAge=function(ab){if(!arguments.length){return p}p=ab;return E};E.scatter_layout=function(ab){if(!arguments.length){return i}i=ab;E.line_layout(!ab);return E};E.line_layout=function(ab){if(!arguments.length){return G}G=ab;E.scatter_layout(!ab);return E};E.transitionDuration=function(ab){if(!arguments.length){return W}W=ab;return E};E.colors=function(ab){if(!arguments.length){return O}O=ab;return E};E.onclick=function(ab){if(!arguments.length){return K}K=ab;return E};E.addDetection=function(ab){if(!arguments.length){return false}E.addDatapoint(f,ab);return E};E.addHeading=function(ab){if(!arguments.length){return false}E.addDatapoint(T,ab);return E};E.addDatapoint=function(ab,ad){if(ab.has(ad.name)){ab.get(ad.name).push({date:ad.time,degree:ad.value,strength:ad.strength?ad.strength:null})}else{ab.set(ad.name,[{date:ad.time,degree:ad.value,strength:ad.strength?ad.strength:null}])}c.push(ad.time);if((!v)&&c.length>=2){v=new Date(c[c.length-1]).getTime()-new Date(c[0]).getTime()}if(j){var ac=0;c.forEach(function(ae,af){var ag=new Date(ad.time).getTime()-new Date(ae).getTime();if(v){if(ag>=v){c.splice(af,1);ab.values().splice(af,1)}}ag=null})}E.update()};return E}})();d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};d3.selection.prototype.moveToBack=function(){return this.each(function(){var a=this.parentNode.firstChild;if(a){this.parentNode.insertBefore(this,a)}})};